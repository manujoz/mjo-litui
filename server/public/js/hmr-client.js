class s{constructor(){if(this.ws=null,this.reconnectAttempts=0,this.maxReconnectAttempts=3,this.reconnectDelay=2e3,this.isConnected=!1,this.isReloading=!1,this.buildInProgress=!1,this.lastBuildCompleteTime=0,this.reloadCooldown=3e3,this.isShuttingDown=!1,this.hasReloadScheduled=!1,window.mjoHMRClient)return console.log("üî• HMR client already exists, reusing instance"),window.mjoHMRClient;window.mjoHMRClient=this,this.init()}init(){if(console.log("üî• Starting HMR client v3.0..."),window.mjHMRInitialized){console.log("üî• HMR already initialized, exiting...");return}window.mjHMRInitialized=!0,this.setupCleanupListeners(),this.connect()}setupCleanupListeners(){window.addEventListener("beforeunload",()=>{console.log("üîÑ Page closing, cleaning up HMR..."),this.isShuttingDown=!0,this.cleanup()}),window.addEventListener("unload",()=>{this.isShuttingDown=!0,this.cleanup()}),document.addEventListener("visibilitychange",()=>{document.hidden&&this.isReloading&&(console.log("üîÑ Page hidden during reload, cleaning up..."),this.cleanup())})}cleanup(){if(console.log("üßπ Cleaning up HMR client..."),this.ws){try{this.ws.close(1e3,"Cleanup")}catch(e){console.log("‚ö†Ô∏è Error closing WebSocket:",e)}this.ws=null}this.isConnected=!1}connect(){if(this.isShuttingDown||this.isReloading||this.hasReloadScheduled){console.log("üî• HMR connection skipped: invalid state");return}if(this.isConnected){console.log("üî• Already connected to HMR");return}const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/hmr`;console.log("üîå Connecting to HMR WebSocket:",o);try{this.ws=new WebSocket(o),this.setupEventListeners()}catch(i){console.error("‚ùå Error creating WebSocket:",i),this.scheduleReconnect()}}setupEventListeners(){this.ws&&(this.ws.onopen=()=>{console.log("‚úÖ HMR client connected"),this.isConnected=!0,this.reconnectAttempts=0,this.showNotification("üî• HMR connected","success")},this.ws.onmessage=e=>{try{const o=JSON.parse(e.data);this.handleHMREvent(o)}catch(o){console.error("‚ùå Error parsing HMR message:",o)}},this.ws.onclose=e=>{console.log("‚ùå HMR WebSocket connection closed:",e.code,e.reason),this.isConnected=!1,!this.isReloading&&this.reconnectAttempts<this.maxReconnectAttempts&&this.scheduleReconnect()},this.ws.onerror=e=>{console.error("‚ö†Ô∏è HMR WebSocket error:",e),this.isConnected=!1})}handleHMREvent(e){var o,i;if(console.log("üì° HMR event received:",e.type,e.data),this.isReloading||this.isShuttingDown||this.hasReloadScheduled){console.log("üîÑ Ignoring HMR event: invalid state");return}switch(e.type){case"build-start":this.buildInProgress=!0,this.showNotification("üî® Building...","info");break;case"build-complete":this.buildInProgress=!1,this.lastBuildCompleteTime=Date.now(),this.showNotification("‚úÖ Build completed","success"),this.scheduleReload();break;case"build-error":this.buildInProgress=!1,this.showNotification(`‚ùå Error: ${((o=e.data)==null?void 0:o.error)||"Unknown error"}`,"error");break;case"file-changed":if(!this.buildInProgress){const t=((i=e.data)==null?void 0:i.files)||[];this.showNotification(`üìù Files changed: ${t.length}`,"info")}break;case"reload":this.scheduleReload();break;default:console.log("ü§∑‚Äç‚ôÇÔ∏è Unhandled HMR event:",e.type)}}scheduleReload(){if(this.hasReloadScheduled||this.isReloading||this.isShuttingDown){console.log("üîÑ Reload already scheduled or in progress");return}const e=Date.now()-this.lastBuildCompleteTime;if(e>0&&e<this.reloadCooldown){console.log(`‚è≥ Reload in cooldown, waiting ${this.reloadCooldown-e}ms more`),setTimeout(()=>this.scheduleReload(),this.reloadCooldown-e);return}console.log("üîÑ Scheduling page reload..."),this.hasReloadScheduled=!0,this.isReloading=!0,this.cleanup(),this.showNotification("üîÑ Reloading page...","info"),setTimeout(()=>{console.log("üîÑ Executing reload..."),window.location.reload()},800)}scheduleReconnect(){if(this.isReloading||this.reconnectAttempts>=this.maxReconnectAttempts){this.reconnectAttempts>=this.maxReconnectAttempts&&(console.log("‚ùå Maximum reconnect attempts reached"),this.showNotification("‚ùå HMR permanently disconnected","error"));return}this.reconnectAttempts++;const e=this.reconnectDelay*Math.pow(1.5,this.reconnectAttempts-1);console.log(`üîÑ Retrying connection in ${e}ms (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`),setTimeout(()=>{!this.isReloading&&!this.isConnected&&this.connect()},e)}createNotificationContainer(){if(document.getElementById("hmr-notifications"))return;const e=document.createElement("div");e.id="hmr-notifications",e.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            pointer-events: none;
        `,document.body.appendChild(e)}showNotification(e,o="info"){this.createNotificationContainer();const i=document.getElementById("hmr-notifications");if(!i)return;this.notificationTimeout&&clearTimeout(this.notificationTimeout),i.innerHTML="";const t=document.createElement("div"),n={info:"#3b82f6",success:"#10b981",error:"#ef4444",warning:"#f59e0b"};t.style.cssText=`
            background: ${n[o]||n.info};
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            pointer-events: auto;
            cursor: pointer;
        `,t.textContent=e,i.appendChild(t),requestAnimationFrame(()=>{t.style.transform="translateX(0)"}),(o!=="error"||e.includes("permanently disconnected"))&&(this.notificationTimeout=window.setTimeout(()=>{t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)},4e3)),t.addEventListener("click",()=>{t.style.transform="translateX(100%)",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},300)})}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{window.mjoHMRClient||new s}):window.mjoHMRClient||new s;
//# sourceMappingURL=hmr-client.js.map
